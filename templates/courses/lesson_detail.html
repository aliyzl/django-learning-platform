{% extends 'base.html' %}
{% load i18n %}
{% load course_filters %}

{% block title %}{{ lesson.get_title|default:lesson.title_en }} - Django Master{% endblock %}

{% block content %}
<div class="lesson-detail-page" style="padding: var(--space-8) 0;">
    <div class="container">
        <!-- Enhanced Breadcrumb -->
        <nav class="breadcrumb" aria-label="{% trans 'Breadcrumb navigation' %}"
            style="margin-bottom: var(--space-6); display: flex; align-items: center; gap: var(--space-2); font-size: 0.9rem; color: var(--text-tertiary);">
            <a href="{% url 'course_list' %}"
                style="color: var(--text-secondary); display: flex; align-items: center; gap: var(--space-1);">
                <i class="fas fa-home" aria-hidden="true"></i>
                <span>{% trans "Courses" %}</span>
            </a>
            <span aria-hidden="true" style="color: var(--text-tertiary);">/</span>
            <a href="{% url 'course_detail' course.slug %}" style="color: var(--text-secondary);">
                {{ course|get_translated:lang }}
            </a>
            <span aria-hidden="true" style="color: var(--text-tertiary);">/</span>
            <span style="color: var(--text-secondary);">{{ section|get_translated:lang }}</span>
            <span aria-hidden="true" style="color: var(--text-tertiary);">/</span>
            <span class="current" aria-current="page" style="color: var(--primary-color); font-weight: 600;">{{ lesson|get_translated:lang }}</span>
        </nav>

        <div class="lesson-content-wrapper"
            style="display: grid; grid-template-columns: 1fr 300px; gap: var(--space-8);">
            <!-- Main Content -->
            <div class="lesson-main">
                <div class="lesson-header"
                    style="margin-bottom: var(--space-8); border-bottom: 1px solid var(--border-color); padding-bottom: var(--space-6);">
                    <h1 style="font-size: 2.5rem; margin-bottom: var(--space-4);">{{ lesson|get_translated:lang }}</h1>
                    {% if user.is_authenticated and user_progress %}
                    <div class="progress-badge"
                        style="display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-4); border-radius: var(--radius-full); font-size: 0.9rem; font-weight: 500; {% if user_progress.completed %}background: var(--success-bg); color: var(--success-color);{% else %}background: var(--warning-bg); color: var(--warning-color);{% endif %}">
                        {% if user_progress.completed %}
                        <i class="fas fa-check-circle"></i> {% trans "Completed" %}
                        {% else %}
                        <i class="fas fa-clock"></i> {% trans "In Progress" %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Lesson Content -->
                <div class="lesson-body">
                    <div class="content-text"
                        style="font-size: 1.1rem; line-height: 1.8; margin-bottom: var(--space-8);">
                        {% if lang == 'fa' %}{{ lesson.content_fa|linebreaks }}{% else %}{{ lesson.content_en|linebreaks }}{% endif %}
                    </div>

                    <!-- Code Example -->
                    {% if lesson.code_example or lesson.code_example_windows or lesson.code_example_mac %}
                    <div class="code-section">
                        <div class="code-header">
                            <h3><i class="fas fa-code"></i> {% trans "Code Example" %}</h3>
                            <div class="platform-tabs">
                                {% if lesson.code_example %}
                                <button class="platform-tab active" data-platform="default">
                                    <i class="fas fa-code"></i>
                                    <span>{% trans "Default" %}</span>
                                </button>
                                {% endif %}
                                {% if lesson.code_example_windows %}
                                <button class="platform-tab" data-platform="windows">
                                    <i class="fab fa-windows"></i>
                                    <span>Windows</span>
                                </button>
                                {% endif %}
                                {% if lesson.code_example_mac %}
                                <button class="platform-tab" data-platform="mac">
                                    <i class="fab fa-apple"></i>
                                    <span>Mac</span>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="code-editor-container">
                            <textarea id="code-editor"
                                class="code-editor">{% if platform == 'windows' and lesson.code_example_windows %}{{ lesson.code_example_windows }}{% elif platform == 'mac' and lesson.code_example_mac %}{{ lesson.code_example_mac }}{% else %}{{ lesson.code_example }}{% endif %}</textarea>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Exercise -->
                    {% if lesson.exercise_en or lesson.exercise_fa %}
                    <div class="exercise-section"
                        style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-6); margin-top: var(--space-8);">
                        <h3
                            style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-4); color: var(--primary-color);">
                            <i class="fas fa-dumbbell"></i> {% trans "Exercise" %}</h3>
                        <div class="exercise-content" style="margin-bottom: var(--space-4);">
                            {% if lang == 'fa' %}{{ lesson.exercise_fa|linebreaks }}{% else %}{{ lesson.exercise_en|linebreaks }}{% endif %}
                        </div>
                        <div class="exercise-editor-container"
                            style="margin-bottom: var(--space-4); border: 1px solid var(--border-color); border-radius: var(--radius);">
                            <textarea id="exercise-editor" class="code-editor"
                                placeholder="{% trans 'Write your solution here...' %}"></textarea>
                        </div>
                        <div class="exercise-actions" style="display: flex; gap: var(--space-4);">
                            <button class="btn btn-primary" onclick="checkExercise()">
                                <i class="fas fa-check"></i> {% trans "Check Solution" %}
                            </button>
                            <button class="btn btn-secondary" onclick="showSolution()">
                                <i class="fas fa-eye"></i> {% trans "Show Solution" %}
                            </button>
                        </div>
                        {% if lesson.exercise_solution %}
                        <div id="solution-container" class="solution-container"
                            style="display: none; margin-top: var(--space-4); background: #282a36; padding: var(--space-4); border-radius: var(--radius); color: #f8f8f2;">
                            <h4 style="color: #bd93f9; margin-bottom: var(--space-2);">{% trans "Solution" %}</h4>
                            <pre><code style="font-family: var(--font-mono);">{{ lesson.exercise_solution }}</code></pre>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Enhanced Navigation -->
                <div class="lesson-navigation" role="navigation" aria-label="{% trans 'Lesson navigation' %}"
                    style="display: flex; justify-content: space-between; margin-top: var(--space-12); gap: var(--space-4);">
                    {% if prev_lesson %}
                    <a href="{% url 'lesson_detail' course.slug section.slug prev_lesson.slug %}" class="nav-link prev"
                        aria-label="{% trans 'Previous lesson' %}"
                        style="flex: 1; padding: var(--space-4); background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); display: flex; align-items: center; gap: var(--space-4); transition: var(--transition);">
                        <i class="fas fa-arrow-left" aria-hidden="true"
                            style="font-size: 1.2rem; color: var(--primary-color);"></i>
                        <div>
                            <span class="nav-label"
                                style="display: block; font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: var(--space-1);">{% trans "Previous" %}</span>
                            <span class="nav-title" style="font-weight: 600; color: var(--text-color);">{{ prev_lesson|get_translated:lang }}</span>
                        </div>
                    </a>
                    {% else %}
                    <div style="flex: 1;"></div>
                    {% endif %}

                    {% if next_lesson %}
                    <a href="{% url 'lesson_detail' course.slug section.slug next_lesson.slug %}" class="nav-link next"
                        aria-label="{% trans 'Next lesson' %}"
                        style="flex: 1; padding: var(--space-4); background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: flex-end; gap: var(--space-4); text-align: right; transition: var(--transition);">
                        <div>
                            <span class="nav-label"
                                style="display: block; font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: var(--space-1);">{% trans "Next" %}</span>
                            <span class="nav-title" style="font-weight: 600; color: var(--text-color);">{{ next_lesson|get_translated:lang }}</span>
                        </div>
                        <i class="fas fa-arrow-right" aria-hidden="true"
                            style="font-size: 1.2rem; color: var(--primary-color);"></i>
                    </a>
                    {% else %}
                    <div style="flex: 1;"></div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lesson-sidebar">
                <div class="sidebar-section"
                    style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-6); position: sticky; top: 100px;">
                    <h3
                        style="font-size: 1.1rem; margin-bottom: var(--space-4); padding-bottom: var(--space-2); border-bottom: 1px solid var(--border-color);">
                        {% trans "Course" %}</h3>
                    <div style="margin-bottom: var(--space-4);">
                        <div style="font-weight: 600; margin-bottom: var(--space-1);">{{ course|get_translated:lang }}</div>
                        <div class="progress-bar"
                            style="height: 6px; background: var(--border-color); border-radius: var(--radius-full); overflow: hidden; margin-top: var(--space-2);">
                            <div class="progress-fill"
                                style="width: 0%; height: 100%; background: var(--success-color); transition: width 1s ease;">
                            </div>
                        </div>
                    </div>

                    <h3
                        style="font-size: 1.1rem; margin-bottom: var(--space-4); padding-bottom: var(--space-2); border-bottom: 1px solid var(--border-color); margin-top: var(--space-6);">
                        {% trans "Lessons" %}</h3>
                    <div class="lessons-list"
                        style="display: flex; flex-direction: column; gap: var(--space-2); max-height: 400px; overflow-y: auto;">
                        {% for l in section.lessons.all %}
                        <a href="{% url 'lesson_detail' course.slug section.slug l.slug %}"
                            class="lesson-item {% if l.id == lesson.id %}active{% endif %}"
                            style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2); border-radius: var(--radius); color: var(--text-secondary); {% if l.id == lesson.id %}background: var(--primary-soft); color: var(--primary-color); font-weight: 600;{% endif %}">
                            <i class="fas {% if l.id == lesson.id %}fa-play-circle{% else %}fa-circle{% endif %}"
                                style="font-size: 0.8rem; {% if l.id == lesson.id %}color: var(--primary-color);{% else %}color: var(--text-tertiary);{% endif %}"></i>
                            <span style="font-size: 0.9rem;">{{ l|get_translated:lang }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <style>
                @media (max-width: 1024px) {
                    .lesson-content-wrapper {
                        grid-template-columns: 1fr;
                    }

                    .lesson-sidebar {
                        display: none;
                    }

                    /* Or move to bottom/drawer */
                }
            </style>
        </div>
    </div>
</div>

<script>
    // Store lesson ID for AI context
    const CURRENT_LESSON_ID = {{ lesson.id }};
    const CURRENT_PLATFORM = '{{ platform }}';

    // Code examples by platform
    const CODE_EXAMPLES = {
        'default': `{{ lesson.code_example|default:''|escapejs }}`,
        'windows': `{{ lesson.code_example_windows|default:''|escapejs }}`,
        'mac': `{{ lesson.code_example_mac|default:''|escapejs }}`
    };

    const EXERCISE_SOLUTION = `{{ lesson.exercise_solution|escapejs }}`;
</script>
{% endblock %}